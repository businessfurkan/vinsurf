import React, { useState, useEffect, useCallback } from 'react';
import '../styles/tyt-ayt-modern.css';
import { useNotifications } from '../context/NotificationContext';
import { keyframes, styled } from '@mui/system';
import { 
  Box, 
  Typography, 
  TextField, 
  Button,
  ButtonGroup,
  FormControl,
  Select,
  MenuItem,
  Tooltip, 
  InputLabel,
  Grid,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  IconButton,
  FormHelperText,
  Chip,
  Card,
  CardContent,
  CircularProgress,
  Snackbar,
  Alert,
  Tabs,
  Tab,
  Divider,
  Avatar,
  Fade,
  Zoom,
  Container,
  Stack
} from '@mui/material';
import { 
  BarChart, 
  Bar, 
  LineChart, 
  Line, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip as RechartsTooltip, 
  Legend, 
  ResponsiveContainer,
  AreaChart,
  Area,
  RadialBarChart,
  RadialBar,
  PieChart,
  Pie,
  Cell
} from 'recharts';
import DeleteIcon from '@mui/icons-material/Delete';
import HelpOutlineIcon from '@mui/icons-material/HelpOutline';
import QueryStatsIcon from '@mui/icons-material/QueryStats';
import RestartAltIcon from '@mui/icons-material/RestartAlt';
import AddCircleOutlineIcon from '@mui/icons-material/AddCircleOutline';
import BarChartIcon from '@mui/icons-material/BarChart';
import TimelineIcon from '@mui/icons-material/Timeline';
import PieChartIcon from '@mui/icons-material/PieChart';
import TrendingUpIcon from '@mui/icons-material/TrendingUp';
import TrendingDownIcon from '@mui/icons-material/TrendingDown';
import EmojiEventsIcon from '@mui/icons-material/EmojiEvents';
import SchoolIcon from '@mui/icons-material/School';
import BookmarkIcon from '@mui/icons-material/Bookmark';
import InsightsIcon from '@mui/icons-material/Insights';
import SaveIcon from '@mui/icons-material/Save';
import FilterListIcon from '@mui/icons-material/FilterList';
import SortIcon from '@mui/icons-material/Sort';

import { auth, db } from '../firebase';
import { useAuthState } from 'react-firebase-hooks/auth';
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  getDocs, 
  orderBy, 
  deleteDoc, 
  doc
} from 'firebase/firestore';

// Define TYT ve AYT subjects
const tytSubjects = [
  'TÃ¼rkÃ§e',
  'Sosyal Bilimler',
  'Temel Matematik',
  'Fen Bilimleri'
];

const aytSubjects = [
  'Matematik',
  'Fizik',
  'Kimya',
  'Biyoloji',
  'Edebiyat',
  'Tarih-1',
  'CoÄŸrafya-1',
  'Tarih-2',
  'CoÄŸrafya-2',
  'Felsefe',
  'Din KÃ¼ltÃ¼rÃ¼',
  'YabancÄ± Dil'
];

// Animations
const pulse = keyframes`
  0% {
    transform: scale(0.95);
    box-shadow: 0 0 0 0 rgba(171, 231, 255, 0.4);
  }
  70% {
    transform: scale(1);
    box-shadow: 0 0 0 10px rgba(171, 231, 255, 0);
  }
  100% {
    transform: scale(0.95);
    box-shadow: 0 0 0 0 rgba(171, 231, 255, 0);
  }
`;

const float = keyframes`
  0% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-10px);
  }
  100% {
    transform: translateY(0px);
  }
`;

const shimmer = keyframes`
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
`;

// Styled components
const StyledCard = styled(Card)(({ theme, color = '#abe7ff' }) => ({
  borderRadius: 16,
  background: '#abe7ff',
  boxShadow: '0 8px 32px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(85, 179, 217, 0.15)',
  border: '1px solid rgba(85, 179, 217, 0.1)',
  transition: 'all 0.3s ease',
  overflow: 'hidden',
  position: 'relative',
  '&:hover': {
    transform: 'translateY(-5px)',
    boxShadow: '0 12px 40px rgba(0, 0, 0, 0.15), 0 8px 16px rgba(85, 179, 217, 0.2)'
  }
}));

const GradientButton = styled(Button)(({ theme, color = '#55b3d9' }) => ({
  background: `linear-gradient(135deg, ${color} 0%, ${color}dd 100%)`,
  color: '#fff',
  fontWeight: 700,
  borderRadius: 12,
  padding: '10px 20px',
  transition: 'all 0.3s ease',
  boxShadow: `0 4px 12px ${color}40`,
  '&:hover': {
    background: `linear-gradient(135deg, ${color}dd 0%, ${color} 100%)`,
    boxShadow: `0 6px 16px ${color}60`,
    transform: 'translateY(-2px)'
  }
}));

const AnimatedBox = styled(Box)(({ theme, animation = pulse, duration = '1.5s' }) => ({
  animation: `${animation} ${duration} infinite`
}));

// Subject color mapping
const subjectColors = {
  'TÃ¼rkÃ§e': '#FF6B6B',
  'Sosyal Bilimler': '#4ECDC4',
  'Temel Matematik': '#FFD166',
  'Fen Bilimleri': '#06D6A0',
  'Matematik': '#118AB2',
  'Fizik': '#073B4C',
  'Kimya': '#7209B7',
  'Biyoloji': '#4CC9F0',
  'Edebiyat': '#F72585',
  'Tarih-1': '#B5838D',
  'CoÄŸrafya-1': '#6D6875',
  'Tarih-2': '#E5989B',
  'CoÄŸrafya-2': '#A7A5C6',
  'Felsefe': '#3D405B',
  'Din KÃ¼ltÃ¼rÃ¼': '#81B29A',
  'YabancÄ± Dil': '#F2CC8F'
};

const TytAytNetTakibi = () => {
  const [user] = useAuthState(auth);
  const [examType, setExamType] = useState('TYT');
  const [subject, setSubject] = useState('');
  const [correctCount, setCorrectCount] = useState('');
  const [incorrectCount, setIncorrectCount] = useState('');
  const [examName, setExamName] = useState('');
  const [examDate, setExamDate] = useState('');
  const [errors, setErrors] = useState({});
  const [netRecords, setNetRecords] = useState([]);
  const [loading, setLoading] = useState(true);
  const [notification, setNotification] = useState({
    open: false,
    message: '',
    severity: 'success'
  });
  const [selectedGraphSubject, setSelectedGraphSubject] = useState('');
  const [selectedRecordsSubject, setSelectedRecordsSubject] = useState('');
  const [selectedExamType, setSelectedExamType] = useState('');
  const [activeTab, setActiveTab] = useState(0);
  const [chartType, setChartType] = useState('bar');
  const [showAddForm, setShowAddForm] = useState(false);
  const [formAnimation, setFormAnimation] = useState(false);
  
  // Bildirim sistemini kullan
  const { addNotification } = useNotifications() || { addNotification: () => {} };

  // Calculate net
  const calculateNet = (correct, incorrect) => {
    const correctNum = parseFloat(correct) || 0;
    const incorrectNum = parseFloat(incorrect) || 0;
    return (correctNum - (incorrectNum * 0.25)).toFixed(2);
  };

  // Close notification
  const handleCloseNotification = () => {
    setNotification({...notification, open: false});
  };

  // Show notification
  const showNotification = (message, severity = 'success') => {
    setNotification({
      open: true,
      message,
      severity
    });
  };

  // GeliÅŸim takibi ve uyarÄ± sistemi
  const compareWithPreviousRecord = useCallback((newRecord) => {
    try {
      if (!netRecords || netRecords.length === 0) return;
      
      // AynÄ± ders ve sÄ±nav tÃ¼rÃ¼ iÃ§in Ã¶nceki kayÄ±tlarÄ± bul
      const previousRecords = netRecords.filter(record => 
        record.examType === newRecord.examType && 
        record.subject === newRecord.subject
      );
      
      if (previousRecords.length === 0) return;
      
      // Tarihe gÃ¶re sÄ±rala (en yeniden en eskiye)
      const sortedRecords = [...previousRecords].sort((a, b) => 
        new Date(b.date) - new Date(a.date)
      );
      
      // En son kayÄ±t
      const lastRecord = sortedRecords[0];
      
      // Yeni kayÄ±t ile son kaydÄ± karÅŸÄ±laÅŸtÄ±r
      const lastNet = parseFloat(lastRecord.net);
      const newNet = parseFloat(newRecord.net);
      
      // Net deÄŸiÅŸimi
      const netDifference = (newNet - lastNet).toFixed(2);
      
      // Bildirim oluÅŸtur
      if (netDifference < 0) {
        // Net dÃ¼ÅŸmÃ¼ÅŸ
        const message = `${newRecord.subject} dersinde bir Ã¶nceki denemene gÃ¶re ${Math.abs(netDifference)} net dÃ¼ÅŸÃ¼ÅŸ var. Daha fazla Ã§alÄ±ÅŸmalÄ±sÄ±n!`;
        if (addNotification) {
          addNotification(message, 'warning', {
            examType: newRecord.examType,
            subject: newRecord.subject,
            netDifference
          });
        }
      } else if (netDifference > 0) {
        // Net artmÄ±ÅŸ
        const message = `${newRecord.subject} dersinde bir Ã¶nceki denemene gÃ¶re ${netDifference} net artÄ±ÅŸ var. Harika ilerliyorsun!`;
        if (addNotification) {
          addNotification(message, 'success', {
            examType: newRecord.examType,
            subject: newRecord.subject,
            netDifference
          });
        }
      } else {
        // Net deÄŸiÅŸmemiÅŸ
        const message = `${newRecord.subject} dersinde bir Ã¶nceki deneme ile aynÄ± neti yaptÄ±n. Biraz daha Ã§alÄ±ÅŸarak netini artÄ±rabilirsin.`;
        if (addNotification) {
          addNotification(message, 'info', {
            examType: newRecord.examType,
            subject: newRecord.subject,
            netDifference
          });
        }
      }
    } catch (error) {
      console.error('GeliÅŸim takibi karÅŸÄ±laÅŸtÄ±rmasÄ±nda hata:', error);
    }
  }, [netRecords, addNotification]);
  
  // Fetch existing net records
  useEffect(() => {
    const fetchNetRecords = async () => {
      try {
        if (!user) {
        // Even if user is not logged in, try to load from localStorage
        try {
          const cachedRecords = localStorage.getItem('netRecords_anonymous');
          if (cachedRecords) {
            const parsedRecords = JSON.parse(cachedRecords);
            // Convert date strings back to Date objects
            const processedRecords = parsedRecords.map(record => ({
              ...record,
              date: new Date(record.date)
            }));
            setNetRecords(processedRecords);
          }
        } catch (localStorageError) {
          console.error('Error loading from localStorage:', localStorageError);
        }
        setLoading(false);
        return;
      }
      } catch (error) {
        console.error('KullanÄ±cÄ± kontrolÃ¼nde hata:', error);
        setLoading(false);
        return;
      }
      
      try {
        setLoading(true);
        
        // First try to get cached records from localStorage
        let cachedRecords = [];
        try {
          const cachedData = localStorage.getItem(`netRecords_${user.uid}`);
          if (cachedData) {
            cachedRecords = JSON.parse(cachedData);
            // Convert date strings back to Date objects
            cachedRecords = cachedRecords.map(record => ({
              ...record,
              date: new Date(record.date instanceof Object ? record.date : new Date(record.date))
            }));
            // Immediately set these records so user sees something while Firestore loads
            setNetRecords(cachedRecords);
          }
        } catch (localStorageError) {
          console.error('Error recovering from localStorage:', localStorageError);
        }
        
        // Store current user ID for future session recovery
        localStorage.setItem('lastNetRecordsUserId', user.uid);
        
        const q = query(
          collection(db, 'netRecords'),
          where('userId', '==', user.uid),
          orderBy('date', 'desc')
        );
        
        const querySnapshot = await getDocs(q);
        const records = [];
        
        querySnapshot.forEach((doc) => {
          // Ensure all date fields are properly handled
          const data = doc.data();
          
          // Convert Firestore timestamps to JavaScript Date objects if needed
          const recordDate = data.date instanceof Date ? data.date : 
            data.date?.toDate ? data.date.toDate() : new Date(data.date?.seconds * 1000 || Date.now());
          
          records.push({
            id: doc.id,
            ...data,
            date: recordDate,
            net: calculateNet(data.correctCount, data.incorrectCount)
          });
        });
        
        // Merge records, preferring Firebase data but including any local-only records
        const mergedRecords = [...records];
        
        // Add any cached records that aren't in the Firestore results
        cachedRecords.forEach(cachedRecord => {
          if (!records.some(r => r.id === cachedRecord.id)) {
            mergedRecords.push(cachedRecord);
          }
        });
        
        // Sort records by date (most recent first)
        mergedRecords.sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          return dateB - dateA;
        });
        
        setNetRecords(mergedRecords);
        
        // Always store in localStorage for persistence
        try {
          localStorage.setItem(`netRecords_${user.uid}`, JSON.stringify(mergedRecords));
        } catch (localStorageError) {
          console.error('Error saving to localStorage:', localStorageError);
        }
      } catch (error) {
        console.error('Error fetching net records:', error);
        
        // Try to recover from localStorage
        try {
          const cachedRecords = localStorage.getItem(`netRecords_${user.uid}`);
          if (cachedRecords) {
            const parsedRecords = JSON.parse(cachedRecords);
            // Convert date strings back to Date objects
            const processedRecords = parsedRecords.map(record => ({
              ...record,
              date: new Date(record.date)
            }));
            setNetRecords(processedRecords);
            showNotification('KayÄ±tlar Ã¶nbelleÄŸinizden yÃ¼klendi', 'info');
          }
        } catch (localStorageError) {
          console.error('Error recovering from localStorage:', localStorageError);
        }
        
        showNotification('KayÄ±tlar yÃ¼klenirken bir hata oluÅŸtu', 'error');
      } finally {
        setLoading(false);
      }
    };
    
    fetchNetRecords();
  }, [user]);

  // Validate form
  const validateForm = () => {
    const newErrors = {};
    
    if (!subject) newErrors.subject = 'LÃ¼tfen bir ders seÃ§in';
    if (!correctCount) newErrors.correctCount = 'DoÄŸru sayÄ±sÄ±nÄ± girin';
    if (!incorrectCount) newErrors.incorrectCount = 'YanlÄ±ÅŸ sayÄ±sÄ±nÄ± girin';
    if (!examName) newErrors.examName = 'Deneme adÄ±nÄ± girin';
    if (!examDate) newErrors.examDate = 'Tarih seÃ§in';
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  // Handle form submission
  const handleSubmit = async () => {
    // Otomatik olarak yeni kayÄ±t yapÄ±ldÄ±ÄŸÄ±nda o dersi seÃ§elim
    setSelectedRecordsSubject(subject);
    if (!validateForm()) return;
    
    try {
      setLoading(true);
      
      // Create the record object
      const newRecord = {
        userId: user ? user.uid : 'anonymous',
        examType,
        subject,
        correctCount: parseFloat(correctCount),
        incorrectCount: parseFloat(incorrectCount),
        examName,
        date: new Date(examDate),
        createdAt: new Date(),
        // Add expiration date - 24 months from now
        expiresAt: new Date(new Date().setMonth(new Date().getMonth() + 24))
      };
      
      let docId = '';
      
      // If user is authenticated, add record to Firestore
      if (user) {
        try {
          // Add record to Firestore
          const docRef = await addDoc(collection(db, 'netRecords'), newRecord);
          docId = docRef.id;
        } catch (firestoreError) {
          console.error('Error saving to Firestore:', firestoreError);
          // Generate local ID as fallback
          docId = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          showNotification('Sunucuya kaydedilemedi, yerel olarak kaydedildi', 'warning');
        }
      } else {
        // Generate a unique ID for local storage
        docId = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
      
      // Add the new record to the state with ID
      const recordWithId = {
        id: docId,
        ...newRecord,
        net: calculateNet(newRecord.correctCount, newRecord.incorrectCount)
      };
      
      // Update the netRecords state immediately
      const updatedRecords = [recordWithId, ...netRecords];
      setNetRecords(updatedRecords);
      
      // Update localStorage to ensure persistence
      try {
        const storageKey = user ? `netRecords_${user.uid}` : 'netRecords_anonymous';
        localStorage.setItem(storageKey, JSON.stringify(updatedRecords));
        if (user) {
          localStorage.setItem('lastNetRecordsUserId', user.uid);
        }
      } catch (localStorageError) {
        console.error('Error saving to localStorage:', localStorageError);
        showNotification('KayÄ±t yerel depolamaya kaydedilemedi', 'warning');
      }
      
      // GeliÅŸim takibi - Ã¶nceki kayÄ±tlarla karÅŸÄ±laÅŸtÄ±r
      try {
        compareWithPreviousRecord(recordWithId);
      } catch (error) {
        console.error('GeliÅŸim takibi karÅŸÄ±laÅŸtÄ±rmasÄ±nda hata:', error);
      }
      
      showNotification(`${examType} ${subject} kaydÄ± baÅŸarÄ±yla eklendi!`);
      
      // Clear form
      setSubject('');
      setCorrectCount('');
      setIncorrectCount('');
      setExamName('');
      setExamDate('');
      
      // Show success notification
      showNotification('Net kaydÄ± baÅŸarÄ±yla eklendi!');
    } catch (error) {
      console.error('Error saving net record:', error);
      showNotification('KayÄ±t sÄ±rasÄ±nda bir hata oluÅŸtu', 'error');
    } finally {
      setLoading(false);
    }
  };

  // Delete record
  const handleDelete = async (id) => {
    try {
      // Only delete from Firestore if it's not a local record and user is logged in
      if (user && !id.startsWith('local_')) {
        await deleteDoc(doc(db, 'netRecords', id));
      }
      
      // Update state
      const updatedRecords = netRecords.filter(record => record.id !== id);
      setNetRecords(updatedRecords);
      
      // Update localStorage to ensure persistence
      try {
        const storageKey = user ? `netRecords_${user.uid}` : 'netRecords_anonymous';
        localStorage.setItem(storageKey, JSON.stringify(updatedRecords));
        
        // If this was the last record, make sure we keep track of the last userId
        if (user && updatedRecords.length === 0) {
          localStorage.setItem('lastNetRecordsUserId', user.uid);
        }
      } catch (localStorageError) {
        console.error('Error updating localStorage after deletion:', localStorageError);
      }
      
      showNotification('KayÄ±t baÅŸarÄ±yla silindi');
    } catch (error) {
      console.error('Error deleting record:', error);
      showNotification('Silme iÅŸlemi sÄ±rasÄ±nda bir hata oluÅŸtu', 'error');
    }
  };

  // Process data for charts
  const processChartData = () => {
    const data = {};
    
    netRecords.forEach(record => {
      if (!data[record.subject]) {
        data[record.subject] = [];
      }
      
      // Format date properly handling both Date objects and Firestore timestamps
      let formattedDate;
      if (record.date instanceof Date) {
        formattedDate = record.date.toLocaleDateString('tr-TR');
      } else if (record.date?.seconds) {
        formattedDate = new Date(record.date.seconds * 1000).toLocaleDateString('tr-TR');
      } else {
        formattedDate = 'N/A';
      }
      
      data[record.subject].push({
        name: record.examName,
        net: parseFloat(record.net),
        doÄŸru: record.correctCount,
        yanlÄ±ÅŸ: record.incorrectCount,
        date: formattedDate
      });
    });
    
    return Object.keys(data).map(subject => ({
      subject,
      data: data[subject].sort((a, b) => {
        // Try to compare by date first
        const dateA = new Date(a.date.split('.').reverse().join('-'));
        const dateB = new Date(b.date.split('.').reverse().join('-'));
        
        if (!isNaN(dateA) && !isNaN(dateB)) {
          return dateA - dateB;
        }
        // Fallback to comparing by name
        return a.name.localeCompare(b.name);
      })
    }));
  };

  const chartData = processChartData();
  
  const formatDate = (date) => {
    if (!date || !date.seconds) return '';
    return new Date(date.seconds * 1000).toLocaleDateString('tr-TR');
  };

  return (
    <Box sx={{ 
      p: 3, 
      pt: 4, 
      pb: 4, 
      background: '#FFFFF0', 
      minHeight: '100vh',
      position: 'relative',
      overflow: 'hidden'
    }}>
      {/* Background pattern */}
      <Box sx={{
        position: 'absolute',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        opacity: 0.4,
        backgroundImage: 'radial-gradient(#55b3d9 1px, transparent 1px), radial-gradient(#55b3d9 1px, transparent 1px)',
        backgroundSize: '40px 40px',
        backgroundPosition: '0 0, 20px 20px',
        pointerEvents: 'none',
        zIndex: 0
      }} />
      
      {/* Page content */}
      <Box sx={{ position: 'relative', zIndex: 1 }}>
        {/* Header */}
        <Box sx={{ 
          display: 'flex', 
          alignItems: 'center', 
          justifyContent: 'space-between',
          mb: 4,
          pb: 2,
          borderBottom: '2px solid #abe7ff'
        }}>
          <Box sx={{ display: 'flex', alignItems: 'center' }}>
            <Avatar sx={{ 
              bgcolor: '#5db6d9', 
              width: 50, 
              height: 50,
              boxShadow: '0 4px 10px rgba(85, 179, 217, 0.3)',
              mr: 2
            }}>
              <InsightsIcon fontSize="large" />
            </Avatar>
            <Typography 
              variant="h4" 
              fontWeight="bold"
              sx={{ 
                fontFamily: 'Poppins, sans-serif',
                color: '#2a5956',
                letterSpacing: '-0.5px'
              }}
            >
              TYT-AYT Net Takibi
            </Typography>
          </Box>
          
          <GradientButton 
            startIcon={showAddForm ? <RestartAltIcon /> : <AddCircleOutlineIcon />}
            onClick={() => {
              setFormAnimation(true);
              setTimeout(() => {
                setShowAddForm(!showAddForm);
                setFormAnimation(false);
              }, 300);
            }}
            color={showAddForm ? '#f44336' : '#55b3d9'}
          >
            {showAddForm ? 'Formu Kapat' : 'Yeni Net Ekle'}
          </GradientButton>
        </Box>

      {/* Main content */}
      <Grid container spacing={3}>
        {/* Form section - conditionally rendered */}
        {showAddForm && (
          <Fade in={!formAnimation} timeout={300}>
            <Grid item xs={12} md={4}>
              <StyledCard sx={{ p: 3 }}>
                <Box sx={{ 
                  display: 'flex', 
                  alignItems: 'center', 
                  mb: 2,
                  pb: 2,
                  borderBottom: '1px solid rgba(85, 179, 217, 0.2)'
                }}>
                  <Avatar sx={{ 
                    bgcolor: '#5db6d9', 
                    width: 36, 
                    height: 36,
                    mr: 1.5
                  }}>
                    <AddCircleOutlineIcon />
                  </Avatar>
                  <Typography 
                    variant="h6" 
                    fontWeight="bold"
                    sx={{ 
                      fontFamily: 'Poppins, sans-serif',
                      color: '#2a5956'
                    }}
                  >
                    Yeni Net Ekle
                  </Typography>
                </Box>
            <FormControl fullWidth margin="normal">
              <InputLabel>SÄ±nav TÃ¼rÃ¼</InputLabel>
              <Select
                value={examType}
                onChange={(e) => {
                  setExamType(e.target.value);
                  setSubject('');
                }}
                label="SÄ±nav TÃ¼rÃ¼"
                sx={{
                  borderRadius: 12,
                  backgroundColor: '#abe7ff',
                  '& .MuiOutlinedInput-notchedOutline': { borderColor: 'rgba(85, 179, 217, 0.2)' },
                  '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: 'rgba(85, 179, 217, 0.5)' },
                  '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#55b3d9' },
                  '& .MuiSelect-select': { fontWeight: 500 }
                }}
                MenuProps={{ 
                  PaperProps: { 
                    sx: { 
                      borderRadius: 2, 
                      boxShadow: '0 8px 16px rgba(0,0,0,0.1)', 
                      mt: 0.5 
                    } 
                  } 
                }}
              >
                <MenuItem value="TYT" sx={{ borderRadius: 8, my: 0.5, mx: 0.5, fontWeight: examType === 'TYT' ? 600 : 400 }}>TYT</MenuItem>
                <MenuItem value="AYT" sx={{ borderRadius: 8, my: 0.5, mx: 0.5, fontWeight: examType === 'AYT' ? 600 : 400 }}>AYT</MenuItem>
              </Select>
            </FormControl>

            <FormControl fullWidth margin="normal">
              <InputLabel>SÄ±nav TÃ¼rÃ¼</InputLabel>
              <Select
                value={examType}
                onChange={(e) => {
                  setExamType(e.target.value);
                  setSubject('');
                }}
                label="SÄ±nav TÃ¼rÃ¼"
                sx={{
                  borderRadius: 2,
                  '& .MuiOutlinedInput-notchedOutline': { borderColor: 'rgba(63, 81, 181, 0.2)' },
                  '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: 'rgba(63, 81, 181, 0.5)' },
                  '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#3f51b5' },
                  '& .MuiSelect-select': { fontWeight: 500 }
                }}
                MenuProps={{ 
                  PaperProps: { 
                    sx: { 
                      borderRadius: 2, 
                      boxShadow: '0 8px 16px rgba(0,0,0,0.1)', 
                      mt: 0.5 
                    } 
                  } 
                }}
              >
                <MenuItem value="TYT" sx={{ borderRadius: 1, my: 0.5, mx: 0.5, fontWeight: examType === 'TYT' ? 600 : 400 }}>TYT</MenuItem>
                <MenuItem value="AYT" sx={{ borderRadius: 1, my: 0.5, mx: 0.5, fontWeight: examType === 'AYT' ? 600 : 400 }}>AYT</MenuItem>
              </Select>
            </FormControl>

            <FormControl fullWidth margin="normal" error={!!errors.subject}>
              <InputLabel>Ders</InputLabel>
              <Select
                value={subject}
                onChange={(e) => setSubject(e.target.value)}
                label="Ders"
                sx={{
                  borderRadius: 2,
                  '& .MuiOutlinedInput-notchedOutline': { borderColor: 'rgba(63, 81, 181, 0.2)' },
                  '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: 'rgba(63, 81, 181, 0.5)' },
                  '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#3f51b5' },
                  '& .MuiSelect-select': { fontWeight: 500 }
                }}
                MenuProps={{ 
                  PaperProps: { 
                    sx: { 
                      borderRadius: 2, 
                      boxShadow: '0 8px 16px rgba(0,0,0,0.1)', 
                      mt: 0.5,
                      maxHeight: 300
                    } 
                  } 
                }}
              >
                {examType === 'TYT' 
                  ? tytSubjects.map(subj => (
                      <MenuItem 
                        key={subj} 
                        value={subj}
                        sx={{
                          borderRadius: 1, 
                          my: 0.5, 
                          mx: 0.5, 
                          fontWeight: subject === subj ? 600 : 400,
                          borderLeft: subject === subj ? '3px solid #3f51b5' : 'none',
                          pl: subject === subj ? 1.5 : 2
                        }}
                      >
                        {subj}
                      </MenuItem>
                    ))
                  : aytSubjects.map(subj => (
                      <MenuItem 
                        key={subj} 
                        value={subj}
                        sx={{
                          borderRadius: 1, 
                          my: 0.5, 
                          mx: 0.5, 
                          fontWeight: subject === subj ? 600 : 400,
                          borderLeft: subject === subj ? '3px solid #3f51b5' : 'none',
                          pl: subject === subj ? 1.5 : 2
                        }}
                      >
                        {subj}
                      </MenuItem>
                    ))
                }
              </Select>
              {errors.subject && <FormHelperText>{errors.subject}</FormHelperText>}
            </FormControl>

            <Grid container spacing={2}>
              <Grid item xs={6}>
                <TextField
                  label="DoÄŸru SayÄ±sÄ±"
                  type="number"
                  value={correctCount}
                  onChange={(e) => setCorrectCount(e.target.value)}
                  fullWidth
                  margin="normal"
                  error={!!errors.correctCount}
                  helperText={errors.correctCount}
                  InputProps={{ 
                    inputProps: { min: 0 },
                    sx: { 
                      borderRadius: 2,
                      '& input': { fontWeight: 600, textAlign: 'center', fontSize: '1.1rem', color: '#4caf50' }
                    }
                  }}
                  sx={{
                    '& .MuiOutlinedInput-root': {
                      borderRadius: 2,
                      '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: '#4caf50' },
                      '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#4caf50' },
                    },
                    '& .MuiInputLabel-root.Mui-focused': { color: '#4caf50' }
                  }}
                />
              </Grid>
              <Grid item xs={6}>
                <TextField
                  label="YanlÄ±ÅŸ SayÄ±sÄ±"
                  type="number"
                  value={incorrectCount}
                  onChange={(e) => setIncorrectCount(e.target.value)}
                  fullWidth
                  margin="normal"
                  error={!!errors.incorrectCount}
                  helperText={errors.incorrectCount}
                  InputProps={{ 
                    inputProps: { min: 0 },
                    sx: { 
                      borderRadius: 2,
                      '& input': { fontWeight: 600, textAlign: 'center', fontSize: '1.1rem', color: '#f44336' }
                    }
                  }}
                  sx={{
                    '& .MuiOutlinedInput-root': {
                      borderRadius: 2,
                      '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: '#f44336' },
                      '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#f44336' },
                    },
                    '& .MuiInputLabel-root.Mui-focused': { color: '#f44336' }
                  }}
                />
              </Grid>
            </Grid>

            <Box 
              sx={{ 
                p: 3, 
                background: 'linear-gradient(135deg, rgba(63, 81, 181, 0.08) 0%, rgba(63, 81, 181, 0.15) 100%)', 
                borderRadius: 3, 
                mt: 3, 
                mb: 3,
                border: '1px solid rgba(63, 81, 181, 0.2)',
                boxShadow: '0 4px 12px rgba(63, 81, 181, 0.1)',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                position: 'relative',
                overflow: 'hidden'
              }}
            >
              <Box sx={{
                position: 'absolute',
                top: 0,
                left: 0,
                width: '100%',
                height: '100%',
                backgroundImage: 'radial-gradient(circle, rgba(255,255,255,0.8) 10%, transparent 10.5%)',
                backgroundSize: '20px 20px',
                opacity: 0.5,
                zIndex: 0
              }} />
              <Typography 
                variant="subtitle2" 
                sx={{ 
                  color: '#3f51b5', 
                  mb: 0.5, 
                  fontWeight: 600,
                  textTransform: 'uppercase',
                  letterSpacing: 1,
                  position: 'relative',
                  zIndex: 1
                }}
              >
                NET SONUÃ‡
              </Typography>
              <Typography 
                variant="h3" 
                align="center" 
                sx={{ 
                  fontWeight: 800, 
                  color: '#3f51b5',
                  fontFamily: 'Poppins, Quicksand, sans-serif',
                  textShadow: '0 2px 10px rgba(63, 81, 181, 0.2)',
                  position: 'relative',
                  zIndex: 1
                }}
              >
                {calculateNet(correctCount, incorrectCount)}
              </Typography>
            </Box>

            <TextField
              label="Deneme AdÄ±"
              value={examName}
              onChange={(e) => setExamName(e.target.value)}
              fullWidth
              margin="normal"
              error={!!errors.examName}
              helperText={errors.examName}
              InputProps={{ 
                sx: { 
                  borderRadius: 2,
                }
              }}
              sx={{
                '& .MuiOutlinedInput-root': {
                  borderRadius: 2,
                  '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: 'rgba(63, 81, 181, 0.5)' },
                  '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#3f51b5' },
                },
                '& .MuiInputLabel-root.Mui-focused': { color: '#3f51b5' }
              }}
            />

            <TextField
              label="Tarih"
              type="date"
              value={examDate}
              onChange={(e) => setExamDate(e.target.value)}
              fullWidth
              margin="normal"
              InputLabelProps={{ shrink: true }}
              error={!!errors.examDate}
              helperText={errors.examDate}
              InputProps={{ 
                sx: { 
                  borderRadius: 2,
                }
              }}
              sx={{
                '& .MuiOutlinedInput-root': {
                  borderRadius: 2,
                  '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: 'rgba(63, 81, 181, 0.5)' },
                  '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#3f51b5' },
                },
                '& .MuiInputLabel-root.Mui-focused': { color: '#3f51b5' }
              }}
            />

            <Button
              variant="contained"
              onClick={handleSubmit}
              fullWidth
              sx={{ 
                mt: 3,
                borderRadius: 2,
                py: 1.5,
                fontFamily: 'Poppins, Quicksand, sans-serif',
                fontWeight: 700,
                background: 'linear-gradient(135deg, #3f51b5 0%, #5c6bc0 100%)',
                boxShadow: '0 4px 12px rgba(63, 81, 181, 0.3)',
                transition: 'all 0.3s ease',
                '&:hover': { 
                  boxShadow: '0 6px 16px rgba(63, 81, 181, 0.4)', 
                  transform: 'translateY(-2px)'
                },
                '&:active': { 
                  transform: 'translateY(0)', 
                  boxShadow: '0 2px 8px rgba(63, 81, 181, 0.3)' 
                },
              }}
            >
              Kaydet
            </Button>
          </Paper>
        </Grid>

        <Grid item xs={12} md={8}>
          <Paper 
            elevation={0} 
            sx={{ 
              p: 3, 
              borderRadius: 3,
              background: 'linear-gradient(145deg, #ffffff 0%, #f5f8ff 100%)',
              boxShadow: '0 8px 32px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(63, 81, 181, 0.15)',
              border: '1px solid rgba(63, 81, 181, 0.1)',
              height: '100%',
              position: 'relative',
              overflow: 'hidden'
            }}
          >
            <Box sx={{ 
              position: 'absolute', 
              top: 0, 
              left: 0, 
              width: '100%', 
              height: '4px', 
              background: 'linear-gradient(90deg, #3f51b5 0%, #5c6bc0 100%)' 
            }} />
            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 3 }}>
              <Typography 
                variant="h6" 
                gutterBottom
                sx={{ 
                  fontWeight: 700, 
                  mb: 0,
                  fontFamily: 'Poppins, Quicksand, sans-serif',
                  display: 'flex',
                  alignItems: 'center',
                  color: '#3f51b5',
                  '&::before': { 
                    content: '""', 
                    width: 3, 
                    height: 18, 
                    backgroundColor: '#3f51b5', 
                    borderRadius: 4, 
                    marginRight: 1.5 
                  },
                }}
              >
                Net KayÄ±tlarÄ±
              </Typography>
              
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
                {/* SÄ±nav TÃ¼rÃ¼ ButonlarÄ± */}
                <ButtonGroup variant="outlined" size="small">
                  <Button 
                    onClick={() => {
                      setSelectedExamType('TYT');
                      setSelectedRecordsSubject('');
                    }}
                    sx={{
                      backgroundColor: selectedExamType === 'TYT' ? 'rgba(63, 81, 181, 0.1)' : 'transparent',
                      borderColor: 'rgba(63, 81, 181, 0.3)',
                      color: selectedExamType === 'TYT' ? '#3f51b5' : 'text.secondary',
                      fontWeight: selectedExamType === 'TYT' ? 600 : 400,
                      '&:hover': {
                        backgroundColor: 'rgba(63, 81, 181, 0.08)',
                        borderColor: 'rgba(63, 81, 181, 0.5)',
                      }
                    }}
                  >
                    TYT
                  </Button>
                  <Button 
                    onClick={() => {
                      setSelectedExamType('AYT');
                      setSelectedRecordsSubject('');
                    }}
                    sx={{
                      backgroundColor: selectedExamType === 'AYT' ? 'rgba(63, 81, 181, 0.1)' : 'transparent',
                      borderColor: 'rgba(63, 81, 181, 0.3)',
                      color: selectedExamType === 'AYT' ? '#3f51b5' : 'text.secondary',
                      fontWeight: selectedExamType === 'AYT' ? 600 : 400,
                      '&:hover': {
                        backgroundColor: 'rgba(63, 81, 181, 0.08)',
                        borderColor: 'rgba(63, 81, 181, 0.5)',
                      }
                    }}
                  >
                    AYT
                  </Button>
                </ButtonGroup>
                
                {/* Ders SeÃ§im MenÃ¼sÃ¼ */}
                {selectedExamType && (
                  <FormControl sx={{ minWidth: 180 }}>
                    <Select
                      value={selectedRecordsSubject}
                      onChange={(e) => setSelectedRecordsSubject(e.target.value)}
                      displayEmpty
                      size="small"
                      sx={{
                        borderRadius: 2,
                        '& .MuiOutlinedInput-notchedOutline': { borderColor: 'rgba(63, 81, 181, 0.2)' },
                        '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: 'rgba(63, 81, 181, 0.5)' },
                        '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#3f51b5' },
                        '& .MuiSelect-select': { fontWeight: 500, py: 1 }
                      }}
                      MenuProps={{ 
                        PaperProps: { 
                          sx: { 
                            borderRadius: 2, 
                            boxShadow: '0 8px 16px rgba(0,0,0,0.1)', 
                            mt: 0.5 
                          } 
                        } 
                      }}
                    >
                      <MenuItem value="" sx={{ borderRadius: 1, my: 0.5, mx: 0.5 }}>
                        <em>TÃ¼m {selectedExamType} Dersleri</em>
                      </MenuItem>
                      {selectedExamType === 'TYT' 
                        ? tytSubjects.map(subj => (
                            <MenuItem 
                              key={subj} 
                              value={subj}
                              sx={{
                                borderRadius: 1, 
                                my: 0.5, 
                                mx: 0.5, 
                                fontWeight: selectedRecordsSubject === subj ? 600 : 400,
                                borderLeft: selectedRecordsSubject === subj ? '3px solid #3f51b5' : 'none',
                                pl: selectedRecordsSubject === subj ? 1.5 : 2
                              }}
                            >
                              {subj}
                            </MenuItem>
                          ))
                        : aytSubjects.map(subj => (
                            <MenuItem 
                              key={subj} 
                              value={subj}
                              sx={{
                                borderRadius: 1, 
                                my: 0.5, 
                                mx: 0.5, 
                                fontWeight: selectedRecordsSubject === subj ? 600 : 400,
                                borderLeft: selectedRecordsSubject === subj ? '3px solid #3f51b5' : 'none',
                                pl: selectedRecordsSubject === subj ? 1.5 : 2
                              }}
                            >
                              {subj}
                            </MenuItem>
                          ))
                      }
                    </Select>
                  </FormControl>
                )}
                
                {/* SÄ±fÄ±rlama Butonu */}
                {(selectedExamType || selectedRecordsSubject) && (
                  <Tooltip title="Filtreleri SÄ±fÄ±rla">
                    <IconButton 
                      size="small" 
                      onClick={() => {
                        setSelectedExamType('');
                        setSelectedRecordsSubject('');
                      }}
                      sx={{ color: 'text.secondary' }}
                    >
                      <RestartAltIcon fontSize="small" />
                    </IconButton>
                  </Tooltip>
                )}
              </Box>
            </Box>

            {loading ? (
              <Box sx={{ display: 'flex', justifyContent: 'center', my: 4 }}>
                <CircularProgress />
              </Box>
            ) : selectedExamType && !selectedRecordsSubject ? (
              <Box sx={{ 
                display: 'flex', 
                flexDirection: 'column', 
                alignItems: 'center', 
                justifyContent: 'center', 
                my: 4, 
                p: 4, 
                bgcolor: 'rgba(63, 81, 181, 0.04)',
                borderRadius: 2,
                border: '1px dashed rgba(63, 81, 181, 0.2)'
              }}>
                <Box sx={{ 
                  width: 80, 
                  height: 80, 
                  borderRadius: '50%', 
                  bgcolor: 'rgba(63, 81, 181, 0.08)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  mb: 2,
                  animation: `${pulse} 1.5s infinite`
                }}>
                  <QueryStatsIcon sx={{ fontSize: 40, color: '#3f51b5' }} />
                </Box>
                <Typography variant="h6" color="primary" fontWeight={600} textAlign="center">
                  LÃ¼tfen verileri gÃ¶rmek istediÄŸiniz dersi seÃ§iniz
                </Typography>
                <Typography variant="body1" color="text.secondary" sx={{ mt: 1, textAlign: 'center' }}>
                  {selectedExamType === 'TYT' ? 'TYT' : 'AYT'} derslerinden birini seÃ§tiÄŸinizde ilgili kayÄ±tlar burada gÃ¶rÃ¼necek ðŸ“Š
                </Typography>
                <Box sx={{ 
                  mt: 3,
                  display: 'flex',
                  alignItems: 'center',
                  gap: 1,
                  bgcolor: 'rgba(63, 81, 181, 0.08)',
                  p: 1.5,
                  px: 2,
                  borderRadius: 2
                }}>
                  <HelpOutlineIcon fontSize="small" color="primary" />
                  <Typography variant="body2" color="text.secondary">
                    Ä°pucu: YukarÄ±daki menÃ¼den bir ders seÃ§in
                  </Typography>
                </Box>
              </Box>
            ) : netRecords.length === 0 ? (
              <Box sx={{ textAlign: 'center', my: 4, color: 'text.secondary' }}>
                <Typography variant="body1">HenÃ¼z net kaydÄ± bulunmuyor.</Typography>
                <Typography variant="body2" sx={{ mt: 1 }}>
                  Denemelere girip netlerinizi takip etmek iÃ§in yukarÄ±daki formu doldurun.
                </Typography>
              </Box>
            ) : netRecords.filter(record => {
              // Hem sÄ±nav tÃ¼rÃ¼ hem de ders seÃ§ildiÄŸinde kayÄ±tlarÄ± gÃ¶ster
              if (selectedExamType && selectedRecordsSubject) {
                return record.examType === selectedExamType && record.subject === selectedRecordsSubject;
              }
              // HiÃ§bir filtre seÃ§ilmediÄŸinde tÃ¼m kayÄ±tlarÄ± gÃ¶ster
              if (!selectedExamType && !selectedRecordsSubject) {
                return true;
              }
              // DiÄŸer durumlarda hiÃ§bir kayÄ±t gÃ¶sterme
              return false;
            }).length === 0 ? (
              <Box sx={{ 
                display: 'flex', 
                flexDirection: 'column', 
                alignItems: 'center', 
                justifyContent: 'center', 
                my: 4, 
                p: 4, 
                bgcolor: 'rgba(0,0,0,0.02)',
                borderRadius: 2,
                border: '1px dashed rgba(0,0,0,0.1)'
              }}>
                <Box sx={{ 
                  width: 60, 
                  height: 60, 
                  borderRadius: '50%', 
                  bgcolor: 'rgba(0,0,0,0.04)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  mb: 2
                }}>
                  <HelpOutlineIcon sx={{ fontSize: 30, color: 'text.disabled' }} />
                </Box>
                {selectedRecordsSubject ? (
                  <>
                    <Typography variant="body1" color="text.secondary" fontWeight={500}>
                      {selectedRecordsSubject} dersine ait kayÄ±t bulunmuyor.
                    </Typography>
                    <Typography variant="body2" color="text.disabled" sx={{ mt: 1 }}>
                      Bu ders iÃ§in kayÄ±t oluÅŸturmak iÃ§in sol taraftaki formu kullanabilirsiniz.
                    </Typography>
                  </>
                ) : selectedExamType ? (
                  <>
                    <Typography variant="body1" color="text.secondary" fontWeight={500}>
                      {selectedExamType} sÄ±navÄ±na ait kayÄ±t bulunmuyor.
                    </Typography>
                    <Typography variant="body2" color="text.disabled" sx={{ mt: 1 }}>
                      {selectedExamType} dersleri iÃ§in kayÄ±t oluÅŸturmak iÃ§in sol taraftaki formu kullanabilirsiniz.
                    </Typography>
                  </>
                ) : (
                  <>
                    <Typography variant="body1" color="text.secondary" fontWeight={500}>
                      HenÃ¼z net kaydÄ± bulunmuyor.
                    </Typography>
                    <Typography variant="body2" color="text.disabled" sx={{ mt: 1 }}>
                      Denemelere girip netlerinizi takip etmek iÃ§in yukarÄ±daki formu doldurun.
                    </Typography>
                  </>
                )}
              </Box>
            ) : (
              <>
                <TableContainer sx={{ mb: 4, borderRadius: 2, overflow: 'hidden', boxShadow: '0 4px 20px rgba(0,0,0,0.08)' }}>
                  <Table>
                    <TableHead>
                      <TableRow sx={{ background: 'linear-gradient(135deg, rgba(63, 81, 181, 0.15) 0%, rgba(63, 81, 181, 0.25) 100%)' }}>
                        <TableCell sx={{ fontWeight: 700, color: '#3f51b5', py: 2, fontSize: '0.95rem' }}>Deneme</TableCell>
                        <TableCell sx={{ fontWeight: 700, color: '#3f51b5', py: 2, fontSize: '0.95rem' }}>SÄ±nav TÃ¼rÃ¼</TableCell>
                        <TableCell sx={{ fontWeight: 700, color: '#3f51b5', py: 2, fontSize: '0.95rem' }}>Ders</TableCell>
                        <TableCell sx={{ fontWeight: 700, color: '#4caf50', py: 2, fontSize: '0.95rem' }}>DoÄŸru</TableCell>
                        <TableCell sx={{ fontWeight: 700, color: '#f44336', py: 2, fontSize: '0.95rem' }}>YanlÄ±ÅŸ</TableCell>
                        <TableCell sx={{ fontWeight: 700, color: '#3f51b5', py: 2, fontSize: '0.95rem' }}>Net</TableCell>
                        <TableCell sx={{ fontWeight: 700, color: '#3f51b5', py: 2, fontSize: '0.95rem' }}>Tarih</TableCell>
                        <TableCell sx={{ py: 2 }}></TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      {netRecords
                        .filter(record => {
                          // Hem sÄ±nav tÃ¼rÃ¼ hem de ders seÃ§ildiÄŸinde kayÄ±tlarÄ± gÃ¶ster
                          if (selectedExamType && selectedRecordsSubject) {
                            return record.examType === selectedExamType && record.subject === selectedRecordsSubject;
                          }
                          // DiÄŸer durumlarda hiÃ§bir kayÄ±t gÃ¶sterme
                          return false;
                        })
                        .map((record, index) => {
                        // Her ders iÃ§in farklÄ± bir renk tonu belirle
                        const subjectColors = {
                          'TÃ¼rkÃ§e': '#3f51b5',
                          'Sosyal Bilimler': '#673ab7',
                          'Temel Matematik': '#2196f3',
                          'Fen Bilimleri': '#009688',
                          'Matematik': '#2196f3',
                          'Fizik': '#00bcd4',
                          'Kimya': '#009688',
                          'Biyoloji': '#4caf50',
                          'Edebiyat': '#ff9800',
                          'Tarih-1': '#795548',
                          'CoÄŸrafya-1': '#607d8b',
                          'Tarih-2': '#8d6e63',
                          'CoÄŸrafya-2': '#78909c',
                          'Felsefe': '#9c27b0',
                          'Din KÃ¼ltÃ¼rÃ¼': '#f44336',
                          'YabancÄ± Dil': '#e91e63'
                        };
                        
                        const subjectColor = subjectColors[record.subject] || '#3f51b5';
                        const rowBgColor = index % 2 === 0 ? 'rgba(0, 0, 0, 0.02)' : 'white';
                        
                        return (
                          <TableRow 
                            key={record.id} 
                            sx={{ 
                              bgcolor: rowBgColor,
                              '&:hover': { bgcolor: `${subjectColor}10` },
                              transition: 'background-color 0.2s ease',
                              borderLeft: `3px solid ${subjectColor}50`
                            }}
                          >
                            <TableCell sx={{ 
                              fontWeight: 700, 
                              color: '#333',
                              fontSize: '0.9rem',
                              py: 1.8
                            }}>
                              {record.examName}
                            </TableCell>
                            <TableCell sx={{ py: 1.8 }}>
                              <Chip 
                                label={record.examType} 
                                size="small" 
                                sx={{ 
                                  fontWeight: 700, 
                                  bgcolor: record.examType === 'TYT' ? 'rgba(63, 81, 181, 0.15)' : 'rgba(156, 39, 176, 0.15)',
                                  color: record.examType === 'TYT' ? '#3f51b5' : '#9c27b0',
                                  border: record.examType === 'TYT' ? '1px solid rgba(63, 81, 181, 0.3)' : '1px solid rgba(156, 39, 176, 0.3)',
                                  borderRadius: 1,
                                  py: 0.8,
                                  boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                                }} 
                              />
                            </TableCell>
                            <TableCell sx={{ 
                              fontWeight: 600, 
                              color: subjectColor,
                              fontSize: '0.9rem',
                              py: 1.8
                            }}>
                              {record.subject}
                            </TableCell>
                            <TableCell sx={{ 
                              fontWeight: 700, 
                              color: '#4caf50',
                              fontSize: '1rem',
                              py: 1.8,
                              bgcolor: 'rgba(76, 175, 80, 0.05)'
                            }}>
                              {record.correctCount}
                            </TableCell>
                            <TableCell sx={{ 
                              fontWeight: 700, 
                              color: '#f44336',
                              fontSize: '1rem',
                              py: 1.8,
                              bgcolor: 'rgba(244, 67, 54, 0.05)'
                            }}>
                              {record.incorrectCount}
                            </TableCell>
                            <TableCell sx={{ 
                              fontWeight: 800, 
                              color: subjectColor,
                              fontSize: '1.1rem',
                              py: 1.8,
                              bgcolor: `${subjectColor}10`,
                              borderRadius: 1,
                              textAlign: 'center',
                              boxShadow: 'inset 0 0 5px rgba(0,0,0,0.05)'
                            }}>
                              {record.net}
                            </TableCell>
                            <TableCell sx={{ 
                              fontWeight: 500,
                              fontSize: '0.85rem',
                              py: 1.8,
                              color: 'text.secondary'
                            }}>
                              {record.date instanceof Date ? record.date.toLocaleDateString('tr-TR') : formatDate(record.date)}
                            </TableCell>
                            <TableCell sx={{ py: 1.8 }}>
                              <IconButton 
                                size="small" 
                                onClick={() => handleDelete(record.id)}
                                sx={{
                                  color: 'rgba(244, 67, 54, 0.7)',
                                  '&:hover': {
                                    bgcolor: 'rgba(244, 67, 54, 0.1)',
                                    color: '#f44336'
                                  },
                                  boxShadow: '0 2px 5px rgba(0,0,0,0.08)'
                                }}
                              >
                                <DeleteIcon fontSize="small" />
                              </IconButton>
                            </TableCell>
                          </TableRow>
                        );
                      })}
                    </TableBody>
                  </Table>
                </TableContainer>

                {chartData.length > 0 && (
                  <Box sx={{ mt: 4 }}>
                    <Typography 
                      variant="h6" 
                      gutterBottom
                      sx={{ 
                        fontWeight: 700, 
                        mb: 3,
                        fontFamily: 'Poppins, Quicksand, sans-serif',
                        display: 'flex',
                        alignItems: 'center',
                        color: '#3f51b5',
                        '&::before': { 
                          content: '""', 
                          width: 3, 
                          height: 18, 
                          backgroundColor: '#3f51b5', 
                          borderRadius: 4, 
                          marginRight: 1.5 
                        },
                      }}
                    >
                      Net GeliÅŸim GrafiÄŸi
                    </Typography>
                    
                    {/* Ders seÃ§im butonlarÄ± */}
                    <Box sx={{ 
                      display: 'flex', 
                      flexWrap: 'wrap', 
                      gap: 1, 
                      mb: 3,
                      justifyContent: { xs: 'center', sm: 'flex-start' }
                    }}>
                      {chartData.map((item) => {
                        // Her ders iÃ§in farklÄ± bir renk tonu belirle
                        const subjectColors = {
                          'TÃ¼rkÃ§e': '#3f51b5',
                          'Sosyal Bilimler': '#673ab7',
                          'Temel Matematik': '#2196f3',
                          'Fen Bilimleri': '#009688',
                          'Matematik': '#2196f3',
                          'Fizik': '#00bcd4',
                          'Kimya': '#009688',
                          'Biyoloji': '#4caf50',
                          'Edebiyat': '#ff9800',
                          'Tarih-1': '#795548',
                          'CoÄŸrafya-1': '#607d8b',
                          'Tarih-2': '#8d6e63',
                          'CoÄŸrafya-2': '#78909c',
                          'Felsefe': '#9c27b0',
                          'Din KÃ¼ltÃ¼rÃ¼': '#f44336',
                          'YabancÄ± Dil': '#e91e63'
                        };
                        
                        const color = subjectColors[item.subject] || '#3f51b5';
                        const isSelected = selectedGraphSubject === item.subject;
                        
                        return (
                          <Button 
                            key={item.subject}
                            variant={isSelected ? "contained" : "outlined"}
                            onClick={() => setSelectedGraphSubject(item.subject)}
                            sx={{
                              borderRadius: 2,
                              px: 2,
                              py: 1,
                              fontWeight: 600,
                              borderColor: isSelected ? color : `${color}50`,
                              color: isSelected ? 'white' : color,
                              backgroundColor: isSelected ? color : 'transparent',
                              '&:hover': {
                                backgroundColor: isSelected ? color : `${color}15`,
                                borderColor: color,
                              },
                              boxShadow: isSelected ? `0 4px 12px ${color}40` : 'none',
                            }}
                          >
                            {item.subject}
                          </Button>
                        );
                      })}
                    </Box>
                    
                    {/* SeÃ§ilen dersin grafiÄŸi */}
                    {selectedGraphSubject ? (
                      (() => {
                        const selectedData = chartData.find(item => item.subject === selectedGraphSubject);
                        if (!selectedData || selectedData.data.length === 0) {
                          return (
                            <Paper 
                              elevation={0}
                              sx={{ 
                                p: 5, 
                                borderRadius: 2, 
                                textAlign: 'center',
                                bgcolor: 'rgba(0,0,0,0.02)',
                                border: '1px dashed rgba(0,0,0,0.1)',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: 2
                              }}
                            >
                              <Box sx={{ 
                                width: 80, 
                                height: 80, 
                                borderRadius: '50%', 
                                bgcolor: 'rgba(0,0,0,0.04)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                              }}>
                                <HelpOutlineIcon sx={{ fontSize: 40, color: 'text.disabled' }} />
                              </Box>
                              <Typography color="text.secondary" fontWeight={500} fontSize="1.1rem">
                                {selectedGraphSubject} dersine ait net verisi bulunamadÄ±.
                              </Typography>
                              <Typography color="text.disabled" fontSize="0.9rem" sx={{ maxWidth: 400 }}>
                                Bu ders iÃ§in net kaydÄ± oluÅŸturmak iÃ§in sol taraftaki formu kullanabilirsiniz.
                              </Typography>
                            </Paper>
                          );
                        }
                        
                        const subjectColors = {
                          'TÃ¼rkÃ§e': '#3f51b5',
                          'Sosyal Bilimler': '#673ab7',
                          'Temel Matematik': '#2196f3',
                          'Fen Bilimleri': '#009688',
                          'Matematik': '#2196f3',
                          'Fizik': '#00bcd4',
                          'Kimya': '#009688',
                          'Biyoloji': '#4caf50',
                          'Edebiyat': '#ff9800',
                          'Tarih-1': '#795548',
                          'CoÄŸrafya-1': '#607d8b',
                          'Tarih-2': '#8d6e63',
                          'CoÄŸrafya-2': '#78909c',
                          'Felsefe': '#9c27b0',
                          'Din KÃ¼ltÃ¼rÃ¼': '#f44336',
                          'YabancÄ± Dil': '#e91e63'
                        };
                        
                        const color = subjectColors[selectedData.subject] || '#3f51b5';
                        const lightColor = `${color}20`;
                        
                        return (
                          <Card 
                            sx={{ 
                              borderRadius: 2,
                              boxShadow: '0 8px 24px rgba(0,0,0,0.08)',
                              border: `1px solid ${color}30`,
                              overflow: 'hidden',
                              transition: 'transform 0.3s ease, box-shadow 0.3s ease',
                              '&:hover': {
                                transform: 'translateY(-4px)',
                                boxShadow: '0 12px 32px rgba(0,0,0,0.12)'
                              }
                            }}
                          >
                            <Box sx={{ 
                              p: 0.5, 
                              background: `linear-gradient(90deg, ${color} 0%, ${color}90 100%)`,
                            }} />
                            <CardContent sx={{ p: 2.5 }}>
                              <Typography 
                                variant="subtitle1" 
                                gutterBottom
                                sx={{ 
                                  fontWeight: 700, 
                                  color: color,
                                  fontFamily: 'Poppins, Quicksand, sans-serif',
                                  fontSize: '1.1rem',
                                  mb: 2
                                }}
                              >
                                {selectedData.subject} Net GeliÅŸimi
                              </Typography>
                              
                              <Box sx={{ 
                                height: 350, 
                                background: `linear-gradient(145deg, #ffffff 0%, ${lightColor} 100%)`,
                                borderRadius: 2,
                                p: 2,
                                boxShadow: 'inset 0 1px 8px rgba(0,0,0,0.05)'
                              }}>
                                <ResponsiveContainer width="100%" height="100%">
                                  <BarChart
                                    data={selectedData.data}
                                    margin={{
                                      top: 5,
                                      right: 30,
                                      left: 20,
                                      bottom: 5,
                                    }}
                                  >
                                    <CartesianGrid strokeDasharray="3 3" />
                                    <XAxis 
                                      dataKey="name" 
                                      angle={-45} 
                                      textAnchor="end"
                                      height={70}
                                      tick={{ fontSize: 12, fill: '#666' }}
                                      axisLine={{ stroke: 'rgba(0,0,0,0.1)' }}
                                    />
                                    <YAxis 
                                      domain={[0, 40]}
                                      allowDecimals={false}
                                      tick={{ fontSize: 12, fill: '#666' }}
                                      axisLine={{ stroke: 'rgba(0,0,0,0.1)' }}
                                    />
                                    <RechartsTooltip />
                                    <Tooltip 
                                      formatter={(value) => [Math.round(value), 'Net']}
                                      contentStyle={{ 
                                        borderRadius: 8, 
                                        boxShadow: '0 4px 16px rgba(0,0,0,0.15)', 
                                        border: 'none' 
                                      }} 
                                    />
                                    <Legend wrapperStyle={{ paddingTop: 10 }} />
                                    <Bar 
                                      dataKey="net" 
                                      name="Net" 
                                      fill={color} 
                                      radius={[6, 6, 0, 0]} 
                                      barSize={30}
                                      animationDuration={1500}
                                    />
                                  </BarChart>
                                </ResponsiveContainer>
                              </Box>
                            </CardContent>
                          </Card>
                        );
                      })()
                    ) : (
                      <Paper 
                        elevation={0}
                        sx={{ 
                          p: 5, 
                          borderRadius: 2, 
                          textAlign: 'center',
                          bgcolor: 'rgba(63, 81, 181, 0.05)',
                          border: '1px dashed rgba(63, 81, 181, 0.2)',
                          display: 'flex',
                          flexDirection: 'column',
                          alignItems: 'center',
                          justifyContent: 'center',
                          gap: 2
                        }}
                      >
                        <Box sx={{ 
                          width: 80, 
                          height: 80, 
                          borderRadius: '50%', 
                          bgcolor: 'rgba(63, 81, 181, 0.1)',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center'
                        }}>
                          <QueryStatsIcon sx={{ fontSize: 40, color: '#3f51b5' }} />
                        </Box>
                        <Typography color="primary" fontWeight={600} fontSize="1.1rem">
                          LÃ¼tfen grafik gÃ¶rmek istediÄŸiniz dersi yukarÄ±dan seÃ§in.
                        </Typography>
                        <Typography color="text.secondary" fontSize="0.9rem" sx={{ maxWidth: 400 }}>
                          Ders butonlarÄ±na tÄ±klayarak ilgili dersin net geliÅŸim grafiÄŸini gÃ¶rebilirsiniz.
                        </Typography>
                      </Paper>
                    )}
                  </Box>
                )}
              </>
            )}
          </Paper>
        </Grid>
      </Grid>
      
      {/* Notification */}
      <Snackbar 
        open={notification.open} 
        autoHideDuration={6000} 
        onClose={handleCloseNotification}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'right' }}
      >
        <Alert 
          onClose={handleCloseNotification} 
          severity={notification.severity} 
          variant="filled"
          sx={{ 
            width: '100%',
            fontWeight: 500,
            boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
          }}
        >
          {notification.message}
        </Alert>
      </Snackbar>
    </Box>
  );
};

export default TytAytNetTakibi;
